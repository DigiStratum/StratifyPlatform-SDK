#!/bin/bash

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

. $SCRIPT_DIR/tools/shell.sh

# Return to where we were executed from upon death
START_DIR=`pwd`
set_death_dir $START_DIR

say "BEGIN"

# Lint all source files first
PASS=1
#for f in `find . -name "*.go"`; do
for f in `find . -type f -name '*.go' | sed -r 's|/[^/]+$||' |sort |uniq`; do
	go vet $f
	if [ $? != 0 ]; then
		PASS=0
	fi
done
if [ $PASS == 0 ]; then
	die "FAILED Vetting stage (see above)!"
fi


# Now run unit tests
PASS=1
for testrunner in `find $SCRIPT_DIR -name "t"`; do
	echo "Running test: '$testrunner'"
	/bin/bash $testrunner
	if [ $? != 0 ]; then
		PASS=0
	fi
done

cd $START_DIR
if [ $PASS == 0 ]; then
	die "FAILED Testing stage (see above)!"
fi
say "\nDONE! :^D"

